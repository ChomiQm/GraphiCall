@page "/project"
@using Microsoft.AspNetCore.Authorization
@using GraphiCall.Client.DTO
@using GraphiCall.Client
@using System.Security.Claims
@using System.Globalization
@using System.Text.Json
@inject NavigationManager Navigation
@inject HttpClient Http
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime
@attribute [Authorize]
@rendermode InteractiveAuto

<PageTitle>Project</PageTitle>

@if (!string.IsNullOrEmpty(Message))
{
    var alertClass = IsErrorMessage ? "alert-danger" : "alert-success";
    <div class=@($"alert {alertClass}")>@Message</div>
}

@if (!isProjectsExists)
{
      <div class="container mt-3">
        <form>
            <div class="form-group">
                <label for="project-name">@(isLang ? "Project name" : "Nazwa projektu") </label>
                <input type="text" class="form-control" id="project-name" @bind="@projectDto.Name" maxlength="50">
            </div>
            <div class="form-group">
                <label for="project-description">@(isLang ? "Project description" : "Opis projektu")</label>
                <textarea class="form-control" id="project-description" rows="3" @bind="@projectDto.Description" maxlength="500"></textarea>
            </div>
            <div class="form-group">
                <label for="project-name">@(isLang ? "Client name" : "Nazwa klienta") </label>
                <input type="text" class="form-control" id="project-name" @bind="@projectDto.ClientName" maxlength="50">
            </div>
            <div class="form-group">
                <label for="project-start-date">@(isLang ? "Start date of project" : "Początkowa data projektu")</label>
                <input type="date" class="form-control" id="project-start-date" @bind="@projectDto.StartDate">
            </div>
            <div class="form-group">
                <label for="project-end-date">@(isLang ? "End date of project" : "Końcowa data projektu")</label>
                <input type="date" class="form-control" id="project-end-date" @bind="@projectDto.EndDate">
            </div>
            <div class="form-group">
                <h1>Create Budget</h1>
                <label for="budget-total-income">@(isLang ? "Budget amount" : "Ilość budżetu")</label>
                <input type="number" class="form-control" id="budget-total-income" min="0.00" @bind="@budgetDto.TotalIncome">
            </div>
            <div class="form-group">
                <label for="budget-total-income">@(isLang ? "Budget period" : "Czas trwania budżetu")</label>
                <input type="date" class="form-control" id="budget-total-income" @bind="@budgetDto.BudgetPeriod">
            </div>

            <button type="button" class="btn btn-primary" @onclick="AddProjectWithBudget">@(isLang ? "Create project" : "Utwórz projekt")</button>
        </form>
    </div>

}
else
{
    <div class="container mt-3">
        @foreach (var project in projects)
        {
            <div class="card my-2">
                <div class="card-body">
                    <h5 class="card-title">@project.Name</h5>
                    <p class="card-text">@project.Description</p>
                    <button class="btn btn-primary" @onclick="() => OpenUpdateModel(project)">@(isLang ? "Update" : "Aktualizuj")</button>
                    <button class="btn btn-info" @onclick="() => OpenBudgetModal(project)">@(isLang ? "Budget data" : "Dane o Budżecie")</button>
                    <button class="btn btn-warning" @onclick="() => OpenTasksModal(project)">@(isLang ? "Tasks" : "Zadania")</button>
                    <button class="btn btn-danger" @onclick="() => DeleteProject(project)">@(isLang ? "Delete" : "Usuń")</button>
                </div>
            </div>
        }
    </div>
}

@if (showUpdateModal)
{
    <div class="modal" tabindex="-1" style="display:block" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(isLang ? "Update project" : "Aktualizuj projekt")</h5>
                    <button type="button" class="close" @onclick="CloseUpdateModel"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control mb-2" @bind="selectedProject.Name" placeholder=@(isLang ? "Project name" : "Nazwa projektu") maxlength="50">
                    <textarea class="form-control mb-2" @bind="selectedProject.Description" placeholder=@(isLang ? "Project description" : "Opis projektu") maxlength="500"></textarea>
                    @* Dodaj więcej pól do edycji według potrzeb *@
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" @onclick="() => UpdateProject(selectedProject)">@(isLang ? "Save changes" : "Zapisz zmiany")</button>
                    <button type="button" class="btn btn-secondary" @onclick="CloseUpdateModel">@(isLang ? "Close" : "Zamknij")</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}


@if (showTasksModal)
{
    <div class="modal show" style="display:block" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(isLang ? "Project Tasks" : "Zadania projektu")</h5>
                    <button type="button" class="close" @onclick="CloseTasksModal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Formularz dodawania nowego zadania -->
                    <div class="form-group">
                        <label for="taskTitle">@(isLang ? "Title" : "Tytuł")</label>
                        <input type="text" class="form-control" id="taskTitle" @bind="@newTask.Title" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label for="taskDescription">@(isLang ? "Description" : "Opis")</label>
                        <textarea class="form-control" id="taskDescription" rows="3" @bind="@newTask.Description" maxlength="500"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="taskDueDate">@(isLang ? "Due date" : "Data")</label>
                        <input type="date" class="form-control" id="taskDueDate" @bind="@newTask.DueDate">
                    </div>
                    <div class="form-group">
                        <label for="taskStatus">Status</label>
                        <select class="form-control" id="taskStatus" @bind="@newTask.Status">
                            @foreach (var status in Enum.GetValues(typeof(GraphiCall.Client.DTO.TaskStatus)))
                            {
                                <option value="@status.ToString()">@status</option>
                            }
                        </select>
                    </div>
                    <button class="btn btn-primary" @onclick="HandleCreateTask">@(isLang ? "Add task" : "Dodaj zadanie")</button>

                    <hr />

                    <!-- Lista istniejących zadań -->
                    @if (selectedTasks.Any())
                    {
                        foreach (var task in selectedTasks)
                        {
                            <div class="p-2 border-bottom">
                                <strong>@task.Title</strong> - @task.Description <br />
                                @(isLang ? "Due" : "Data"): @task.DueDate.ToString("yyyy-MM-dd") <br />
                                Status: @task.Status.ToString()
                                <button class="btn btn-primary" @onclick="() => OpenUpdateTaskModal(task)">@(isLang ? "Update" : "Aktualizuj")</button>
                                <button class="btn btn-danger" @onclick="() => DeleteTask(task)">@(isLang ? "Delete" : "Usuń")</button>
                            </div>
                        }
                    }
                    else
                    {
                        <div>@(isLang ? "No tasks found for this project." : "Nie znaleziono żadnych zadań dla tego projektu.")</div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseTasksModal">@(isLang ? "Close" : "Zamknij")</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop show"></div>
}

@if (showUpdateTaskModal)
{
    <div class="modal show" style="display:block" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(isLang ? "Update Task" : "Aktualizuj zadanie")</h5>
                    <button type="button" class="close" @onclick="CloseUpdateTaskModal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="updateTaskTitle">@(isLang ? "Title" : "Tytuł")</label>
                        <input type="text" class="form-control" id="updateTaskTitle" @bind="selectedTaskForUpdate.Title" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label for="updateTaskDescription">@(isLang ? "Description" : "Opis")</label>
                        <textarea class="form-control" id="updateTaskDescription" rows="3" @bind="selectedTaskForUpdate.Description" maxlength="500"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="updateTaskDueDate">@(isLang ? "Due date" : "Data")</label>
                        <input type="date" class="form-control" id="updateTaskDueDate" @bind="selectedTaskForUpdate.DueDate">
                    </div>
                    <div class="form-group">
                        <label for="updateTaskStatus">Status</label>
                        <select class="form-control" id="updateTaskStatus" @bind="selectedTaskForUpdate.Status">
                            @foreach (var status in Enum.GetValues(typeof(GraphiCall.Client.DTO.TaskStatus)))
                            {
                                <option value="@status">@status</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" @onclick="() => UpdateTask(selectedTaskForUpdate)">@(isLang ? "Save changes" : "Zapisz zmiany")</button>
                    <button type="button" class="btn btn-secondary" @onclick="CloseUpdateTaskModal">@(isLang ? "Close" : "Zamknij")</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop show"></div>
}

@if (showBudgetModal && selectedBudget != null)
{
    <div class="modal show" style="display:block" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(isLang ? "Budget Details" : "Detale budżetu")</h5>
                    <button type="button" class="close" @onclick="CloseBudgetModal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label for="budgetPeriod">@(isLang ? "Budget Period" : "Czas końca budżetu")</label>
                            <p>Budget period: @selectedBudget.BudgetPeriod</p>
                        </div>
                    </form>
                    <p>@(isLang ? "Total Income" : "Całkowity przychód"): @selectedBudget.TotalIncome</p>
                    <p>@(isLang ? "Total Expenses" : "Całkowite wydatki"): @selectedBudget.TotalExpenses</p>
                    <p>@(isLang ? "Balance" : "Balans"): @selectedBudget.Balance</p>

                    <hr />
                    <h5>@(isLang ? "Expenses" : "Wydatki")</h5>
                    @if (selectedBudget.Expenses != null && selectedBudget.Expenses.Any())
                    {
                        foreach (var expense in selectedBudget.Expenses)
                        {
                            <div>
                                <strong>@expense.Category:</strong> @expense.Amount (Date: @expense.DateIncurred.ToString("yyyy-MM-dd"))
                                <button class="btn btn-primary btn-sm" @onclick="() => OpenUpdateExpenseModal(expense)">@(isLang ? "Update" : "Zaktualizuj")</button>
                                <button class="btn btn-danger btn-sm" @onclick="() => DeleteExpense(expense)">@(isLang ? "Delete" : "Usuń")</button>
                            </div>
                        }
                    }
                    else
                    {
                        <div>@(isLang ? "No expenses found for this budget." : "Nie znaleziono wydatków dla tego budżetu")</div>
                    }
                </div>
                <button type="button" class="btn btn-primary" @onclick="() => OpenAddExpenseModal(selectedBudget)">@(isLang ? "Add expense" : "Dodaj wydatek")</button>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" @onclick="() => UpdateBudget(selectedBudget)">@(isLang ? "Save Changes" : "Zapisz zmiany")</button>
                    <button type="button" class="btn btn-secondary" @onclick="CloseBudgetModal">@(isLang ? "Close" : "Zamknij")</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop show"></div>
}

@if (showAddExpenseModal)
{
    <div class="modal show" style="display:block" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(isLang ? "Add New Expense" : "Dodaj nowy wydatek")</h5>
                    <button type="button" class="close" @onclick="CloseAddExpenseModal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <!-- Pola formularza do dodania wydatku -->
                        <div class="form-group">
                            <label for="expenseCategory">@(isLang ? "Category" : "Kategoria")</label>
                            <input type="text" class="form-control" id="expenseCategory" @bind="@newExpense.Category" maxlength="50">
                        </div>
                        <div class="form-group">
                            <label for="expenseAmount">@(isLang ? "Amount" : "Ilość")</label>
                            <input type="number" class="form-control" min="0.00" max="@selectedBudget.Balance" id="expenseAmount" @bind="@newExpense.Amount">
                        </div>
                        <div class="form-group">
                            <label for="expenseDate">@(isLang ? "Date" : "Data")</label>
                            <input type="date" class="form-control" id="expenseDate" @bind="@newExpense.DateIncurred">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" @onclick="() => CreateExpense(newExpense)">@(isLang ? "Add expense" : "Dodaj wydatek")</button>
                    <button type="button" class="btn btn-secondary" @onclick="CloseAddExpenseModal">@(isLang ? "Close" : "Zamknij")</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop show"></div>
}

@if (showUpdateExpenseModal && selectedExpenseForUpdate != null)
{
    <div class="modal show" style="display:block" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(isLang ? "Update Expense" : "Altualizuj wydatek")</h5>
                    <button type="button" class="close" @onclick="CloseUpdateExpenseModal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <!-- Pola formularza do aktualizacji wydatku -->
                        <div class="form-group">
                            <label for="updateExpenseAmount">@(isLang ? "Amount" : "Ilość")</label>
                            <input type="number" class="form-control" min="0.00" max="@selectedBudget.Balance" id="updateExpenseAmount" @bind="@selectedExpenseForUpdate.Amount">
                        </div>
                        <div class="form-group">
                            <label for="updateExpenseDate">@(isLang ? "Date" : "Data")</label>
                            <input type="date" class="form-control" id="updateExpenseDate" @bind="@selectedExpenseForUpdate.DateIncurred">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" @onclick="() => UpdateExpense(selectedExpenseForUpdate)">@(isLang ? "Save Changes" : "Zapisz zmiany")</button>
                    <button type="button" class="btn btn-secondary" @onclick="CloseUpdateExpenseModal">@(isLang ? "Close" : "Zamknij")</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop show"></div>
}


@code {
    //ON BUILDING SETUP -----------------------------------------------------------------------------
    private string userId = null!;
    public bool isLang { get; set; }

    //LIST
    private List<ProjectDto> projects = new List<ProjectDto>();
    private List<ProjectTaskDto> selectedTasks = new List<ProjectTaskDto>();

    //CREATE
    private ProjectDto projectDto = new ProjectDto
        {
            StartDate = DateTime.Now,
            EndDate = DateTime.Now
        };
    private BudgetDto budgetDto = new BudgetDto()
        {
            BudgetPeriod = DateTime.Now
        };
    private ProjectTaskDto newTask = new ProjectTaskDto()
        {
            DueDate = DateTime.Now
        };
    private ExpenseDto newExpense = new ExpenseDto()
        {
            DateIncurred = DateTime.Now
        };

    //EDIT PROJECT
    private ProjectDto? selectedProject;
    private bool showUpdateModal = false;

    //EDIT TASKS
    private ProjectTaskDto? selectedTaskForUpdate;
    private bool showUpdateTaskModal = false;

    //CHECKS
    private bool isProjectsExists = false;

    //ALLERT
    private string Message = string.Empty;
    private bool IsErrorMessage = false;

    //BUDGET MODEL
    private BudgetDto selectedBudget = new BudgetDto();
    private bool showBudgetModal = false;

    //TASKS MODEL
    private bool showTasksModal = false;

    //EXPENSE MODEL
    private bool showAddExpenseModal = false;

    //UPDATE EXPENSE MODEL
    private ExpenseDto? selectedExpenseForUpdate;
    private bool showUpdateExpenseModal = false;
    private ExpenseDto? originalExpenseForUpdate;
    //SETUP METHODS

    protected override async Task OnInitializedAsync()
    {
        isLang = await Http.GetFromJsonAsync<bool>(Navigation.BaseUri + "language/getLang");
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        }

        await CheckIfUserHasProjects();

        if (isProjectsExists)
        {
            await LoadProjects();
        }

    }

    private async Task CheckIfUserHasProjects()
    {
        try
        {
            if (!string.IsNullOrEmpty(userId))
            {
                var response = await Http.GetAsync(Navigation.BaseUri + $"projects/hasProjects/{userId}");
                if (response.IsSuccessStatusCode)
                {
                    isProjectsExists = await response.Content.ReadFromJsonAsync<bool>();
                }
                else
                {
                    IsErrorMessage = true;
                    Message = "Failed to check projects with budget.";
                    _ = HideMessageAfterDelay();
                }
            }
            else
            {
                IsErrorMessage = true;
                Message = "Unauthorized.";
                _ = HideMessageAfterDelay();
            }
        }
        catch (Exception ex)
        {
            IsErrorMessage = true;
            Message = $"An exception occured: {ex.Message}";
            _ = HideMessageAfterDelay();  
        }
        StateHasChanged();
    }

    // PROJECT CRUD

    private async Task AddProjectWithBudget()
    {
        // Walidacja dat
        if (projectDto.StartDate >= projectDto.EndDate)
        {
            IsErrorMessage = true;
            Message = "Start date must be earlier than the end date.";
            _ = HideMessageAfterDelay();
            StateHasChanged();
            return;
        }

        if (projectDto.StartDate < DateTime.Today || projectDto.EndDate < DateTime.Today)
        {
            IsErrorMessage = true;
            Message = "Start date and end date must be future dates.";
            _ = HideMessageAfterDelay();
            StateHasChanged();
            return;
        }

        // Przypisanie ID
        projectDto.ApplicationUserId = userId;
        projectDto.ProjectId = Guid.NewGuid().ToString();
        budgetDto.BudgetId = Guid.NewGuid().ToString();
        projectDto.BudgetId = budgetDto.BudgetId;
        budgetDto.ProjectId = projectDto.ProjectId;

        // Tworzenie projektu
        var projectResponse = await Http.PostAsJsonAsync($"{Navigation.BaseUri}projects/addProject/{userId}", projectDto);
        if (projectResponse.IsSuccessStatusCode)
        {
            var budgetResponse = await Http.PostAsJsonAsync($"{Navigation.BaseUri}budgets/addBudget/{userId}/project/{projectDto.ProjectId}", budgetDto);
            if (budgetResponse.IsSuccessStatusCode)
            {
                IsErrorMessage = false;
                Message = "Project and its budget created successfully.";
                await CheckIfUserHasProjects();
                await LoadProjects();
            }
            else
            {
                IsErrorMessage = true;
                Message = "Project created, but failed to create its budget.";
            }
        }
        else
        {
            IsErrorMessage = true;
            Message = "Failed to create a project.";
        }

        _ = HideMessageAfterDelay();
        StateHasChanged();
    }


    private async Task SetSelectedProjectByBudgetId(string budgetId)
    {
        var response = await Http.GetAsync(Navigation.BaseUri + $"projects/getProjectByBudgetId/{budgetId}");

        if (response.IsSuccessStatusCode)
        {
            var projectJsonString = await response.Content.ReadAsStringAsync();
            selectedProject = JsonSerializer.Deserialize<ProjectDto>(projectJsonString, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
        }
        else
        {
            IsErrorMessage = true;
            Message = "Failed to get a project.";
        }
    }


    private async Task LoadProjects()
    {
        var response = await Http.GetAsync(Navigation.BaseUri + $"projects/getAllProjects/{userId}/with-everything");
        if (response.IsSuccessStatusCode)
        {
            var jsonString = await response.Content.ReadAsStringAsync();
            projects = JsonSerializer.Deserialize<List<ProjectDto>>(jsonString, new JsonSerializerOptions { PropertyNameCaseInsensitive = true, IgnoreNullValues = true }) ?? new List<ProjectDto>();
        }
        else
        {
            IsErrorMessage = true;
            Message = "Failed to load projects.";
            _ = HideMessageAfterDelay();
        }
        StateHasChanged();
    }

    private async Task UpdateProject(ProjectDto project)
    {
        var response = await Http.PutAsJsonAsync(Navigation.BaseUri + $"projects/updateProject/{userId}/{project.ProjectId}/Params", project);
        if (response.IsSuccessStatusCode)
        {
            CloseUpdateModel();
            await LoadProjects();
            Message = "Project params updated successfully.";
            IsErrorMessage = false;
        }
        else
        {
            Message = "Error occurred while updating the project params.";
            IsErrorMessage = true;
        }
        _ = HideMessageAfterDelay();
        StateHasChanged();
    }

    private async Task DeleteProject(ProjectDto project)
    {
        var response = await Http.DeleteAsync(Navigation.BaseUri + $"projects/deleteProject/{userId}/{project.ProjectId}");
        if (response.IsSuccessStatusCode)
        {
            projects.Remove(project); 
            Message = "Project deleted successfully.";
            IsErrorMessage = false;
            await CheckIfUserHasProjects();
            if (isProjectsExists)
            {
                await LoadProjects(); 
            }
        }
        else
        {
            IsErrorMessage = true;
            Message = "Error occurred while deleting the project.";
        }
        _ = HideMessageAfterDelay();
        StateHasChanged();
    }

    // CRUD BUDGET
    private async Task OpenBudgetModal(ProjectDto project)
    {
        // Pobieranie szczegółów budżetu
        var budgetResponse = await Http.GetAsync(Navigation.BaseUri + $"budgets/getBudget/{userId}/project/{project.ProjectId}/budget/{project.BudgetId}");
        if (budgetResponse.IsSuccessStatusCode)
        {
            var budgetJsonString = await budgetResponse.Content.ReadAsStringAsync();
            selectedBudget = JsonSerializer.Deserialize<BudgetDto>(budgetJsonString, new JsonSerializerOptions { PropertyNameCaseInsensitive = true, IgnoreNullValues = true });

            // Oddzielne żądanie dla pobrania wydatków
            await LoadExpenses(selectedBudget.BudgetId);

            // Otwieranie modala z detalami budżetu
            showBudgetModal = true;
        }
        else
        {
            // Obsługa błędu, gdy nie można pobrać szczegółów budżetu
            showBudgetModal = false;
            IsErrorMessage = true;
            Message = "Error occurred while opening the budget modal.";
            _ = HideMessageAfterDelay();
        }
        StateHasChanged();
    }

    private async Task UpdateBudget(BudgetDto budgetToUpdate)
    {
        if (budgetToUpdate is null)
        {
            throw new InvalidOperationException("Budget to update cannot be null.");
        }

        var response = await Http.PutAsJsonAsync(
            $"{Navigation.BaseUri}budgets/updateBudget/{userId}/project/{budgetToUpdate.ProjectId}/budget/{budgetToUpdate.BudgetId}",
            budgetToUpdate);

        if (response.IsSuccessStatusCode)
        {
            // Najpierw ustaw selectedProject za pomocą istniejącej metody
            await SetSelectedProjectByBudgetId(budgetToUpdate.BudgetId);

            // Sprawdź, czy selectedProject został pomyślnie ustawiony
            if (selectedProject != null)
            {
                // Budżet został pomyślnie zaktualizowany
                Message = "Budget updated successfully.";
                IsErrorMessage = false;
            }
            else
            {
                IsErrorMessage = true;
                Message = "Failed to set selected project.";
            }
        }
        else
        {
            // Obsługa błędu
            IsErrorMessage = true;
            Message = "Error occurred while updating the budget.";
        }

        _ = HideMessageAfterDelay();
        StateHasChanged();
    }


    // CRUD TASK

    private async Task OpenTasksModal(ProjectDto project)
    {
        selectedProject = project;
        var response = await Http.GetAsync(Navigation.BaseUri + $"tasks/getTasks/{userId}/projects/{project.ProjectId}/tasks");
        if (response.IsSuccessStatusCode)
        {
            var jsonString = await response.Content.ReadAsStringAsync();
            selectedTasks = JsonSerializer.Deserialize<List<ProjectTaskDto>>(jsonString, new JsonSerializerOptions { PropertyNameCaseInsensitive = true }) ?? new List<ProjectTaskDto>();
            showTasksModal = true;
        }
        else
        {
            selectedTasks = new List<ProjectTaskDto>(); // Aby uniknąć błędów null reference przy braku zadań.
            showTasksModal = true; // Pokaż modal nawet jeśli jest pusty, aby poinformować użytkownika o braku zadań.
            IsErrorMessage = true;
            Message = "Error occurred while trying to load tasks.";
            _ = HideMessageAfterDelay();
        }
        StateHasChanged();
    }

    private async Task HandleCreateTask()
    {
        if (selectedProject == null)
        {
            throw new InvalidOperationException("No project selected.");
        }

        if (newTask == null)
        {
            newTask = new ProjectTaskDto();
        }

        newTask.ProjectTaskId = Guid.NewGuid().ToString();
        newTask.ProjectID = selectedProject.ProjectId; // Założenie, że selectedProject jest aktualnie wybranym projektem

        var response = await Http.PostAsJsonAsync(Navigation.BaseUri + $"tasks/addTask/{userId}/projects/{newTask.ProjectID}", newTask);
        if (response.IsSuccessStatusCode)
        {
            // Zadanie zostało pomyślnie utworzone, więc należy załadować listę zadań ponownie
            await OpenTasksModal(selectedProject);
            newTask = new ProjectTaskDto(); // Resetowanie formularza
        }
        else
        {
            // Obsługa błędu
            IsErrorMessage = true;
            Message = "Error occurred while creating the task.";
            _ = HideMessageAfterDelay();
        }
        StateHasChanged();
    }

    private async Task UpdateTask(ProjectTaskDto taskToUpdate)
    {
        if (taskToUpdate is null)
        {
            throw new InvalidOperationException("Task to update cannot be null.");
        }

        var response = await Http.PutAsJsonAsync(
            Navigation.BaseUri + $"tasks/updateTask/{userId}/projects/{taskToUpdate.ProjectID}/task/{taskToUpdate.ProjectTaskId}",
            taskToUpdate);

        if (response.IsSuccessStatusCode)
        {
            // Zadanie zostało pomyślnie zaktualizowane, więc należy załadować listę zadań ponownie
            await OpenTasksModal(selectedProject);
            CloseUpdateTaskModal();
            Message = "Task updated successfully.";
            IsErrorMessage = false;
        }
        else
        {
            // Obsługa błędu
            IsErrorMessage = true;
            Message = "Error occurred while updating the task.";
        }
        _ = HideMessageAfterDelay();
        StateHasChanged();
    }

    private async Task DeleteTask(ProjectTaskDto taskToDelete)
    {
        if (taskToDelete is null)
        {
            throw new InvalidOperationException("Task to delete cannot be null.");
        }

        var response = await Http.DeleteAsync(
            Navigation.BaseUri + $"tasks/deleteTask/{userId}/projects/{taskToDelete.ProjectID}/task/{taskToDelete.ProjectTaskId}");

        if (response.IsSuccessStatusCode)
        {
            // Zadanie zostało pomyślnie usunięte, więc należy załadować listę zadań ponownie
            await OpenTasksModal(selectedProject);
            Message = "Task deleted successfully.";
            IsErrorMessage = false;
        }
        else
        {
            // Obsługa błędu
            IsErrorMessage = true;
            Message = "Error occurred while deleting the task.";
        }
        _ = HideMessageAfterDelay();
        StateHasChanged();
    }


    // CRUD EXPENSE

    private async Task LoadExpenses(string budgetId)
    {
        var expenseResponse = await Http.GetAsync(Navigation.BaseUri + $"expenses/getExpenses/{userId}/budgets/{budgetId}/allExpenses");
        if (expenseResponse.IsSuccessStatusCode)
        {
            var expenseJsonString = await expenseResponse.Content.ReadAsStringAsync();
            selectedBudget.Expenses = JsonSerializer.Deserialize<List<ExpenseDto>>(expenseJsonString, new JsonSerializerOptions { PropertyNameCaseInsensitive = true, IgnoreNullValues = true });
            // W przypadku sukcesu, lista wydatków zostaje zaktualizowana
        }
        else
        {
            selectedBudget.Expenses = new List<ExpenseDto>(); // Inicjalizacja pustej listy, gdy żądanie nie powiedzie się
                                                              // Możesz również tutaj ustawić odpowiedni komunikat o błędzie
            IsErrorMessage = true;
            Message = "Error occurred while loading expenses.";
            _ = HideMessageAfterDelay();
        }
    }


    private async Task CreateExpense(ExpenseDto expense)
    {
        if (expense == null || selectedBudget == null)
        {
            IsErrorMessage = true;
            Message = "Expense data or selected budget is null.";
            _ = HideMessageAfterDelay();
            return;
        }

        if (expense.Amount <= 0)
        {
            IsErrorMessage = true;
            Message = "The amount must be greater than 0.";
            _ = HideMessageAfterDelay();
            return;
        }

        if (expense.Amount > selectedBudget.Balance)
        {
            IsErrorMessage = true;
            Message = "The amount cannot exceed the available budget balance.";
            _ = HideMessageAfterDelay();
            return;
        }

        expense.ExpenseId = Guid.NewGuid().ToString();
        expense.FK_BudgetId = selectedBudget.BudgetId;

        var response = await Http.PostAsJsonAsync(
            $"{Navigation.BaseUri}expenses/addExpense/{userId}/budgets/{selectedBudget.BudgetId}",
            expense);

        if (response.IsSuccessStatusCode)
        {
            IsErrorMessage = false;
            Message = "Expense added successfully.";

            // Aktualizacja całkowitych wydatków
            selectedBudget.TotalExpenses += expense.Amount;

            // Ponowne załadowanie wydatków i aktualizacja budżetu
            await LoadExpenses(selectedBudget.BudgetId);
            await UpdateBudget(selectedBudget);
        }
        else
        {
            IsErrorMessage = true;
            Message = "Failed to add expense.";
        }

        _ = HideMessageAfterDelay();
        StateHasChanged();
    }


    private async Task UpdateExpense(ExpenseDto updatedExpense)
    {
        if (updatedExpense == null || selectedBudget == null || originalExpenseForUpdate == null)
        {
            IsErrorMessage = true;
            Message = "Cannot update as one of the required objects is null.";
            _ = HideMessageAfterDelay();
            return;
        }

        if (updatedExpense.Amount <= 0)
        {
            IsErrorMessage = true;
            Message = "The amount must be greater than 0.";
            _ = HideMessageAfterDelay();
            return;
        }

        var newTotalExpenses = selectedBudget.TotalExpenses - originalExpenseForUpdate.Amount + updatedExpense.Amount;
        if (newTotalExpenses > selectedBudget.TotalIncome)
        {
            IsErrorMessage = true;
            Message = "The updated amount cannot exceed the available budget balance.";
            _ = HideMessageAfterDelay();
            return;
        }

        // Oblicz różnicę w kwocie i zaktualizuj TotalExpenses
        var amountDifference = updatedExpense.Amount - originalExpenseForUpdate.Amount;
        selectedBudget.TotalExpenses += amountDifference;

        var response = await Http.PutAsJsonAsync($"{Navigation.BaseUri}expenses/updateExpense/{userId}/budgets/{updatedExpense.FK_BudgetId}/expense/{updatedExpense.ExpenseId}", updatedExpense);
        if (response.IsSuccessStatusCode)
        {
            // Aktualizuj wydatek w lokalnej liście
            var expenseIndex = selectedBudget.Expenses.FindIndex(e => e.ExpenseId == updatedExpense.ExpenseId);
            if (expenseIndex != -1)
            {
                selectedBudget.Expenses[expenseIndex] = updatedExpense;
            }
            else
            {
                IsErrorMessage = true;
                Message = "Failed to find the expense in the list for updating.";
                _ = HideMessageAfterDelay();
                StateHasChanged();
                return;
            }

            await UpdateBudget(selectedBudget);

            CloseUpdateExpenseModal();

            Message = "Expense updated successfully.";
            IsErrorMessage = false;
        }
        else
        {
            // If the response is not successful, revert the changes
            selectedBudget.TotalExpenses -= amountDifference;

            IsErrorMessage = true;
            Message = "Failed to update expense.";
        }

        _ = HideMessageAfterDelay();
        StateHasChanged();
    }


    private async Task DeleteExpense(ExpenseDto expense)
    {
        if (expense == null || selectedBudget == null)
        {
            IsErrorMessage = true;
            Message = "Cannot delete null expense or selected budget is null.";
            _ = HideMessageAfterDelay();
            return;
        }

    var response = await Http.DeleteAsync(
        Navigation.BaseUri + $"expenses/deleteExpense/{userId}/budgets/{expense.FK_BudgetId}/expense/{expense.ExpenseId}");

        if (response.IsSuccessStatusCode)
        {
            // Usuń wydatek z lokalnej listy, aby odświeżyć UI
            selectedBudget.Expenses.Remove(expense);

            // Zaktualizuj całkowite wydatki i bilans w budżecie
            selectedBudget.TotalExpenses -= expense.Amount;

            // Aktualizuj budżet na serwerze
            await UpdateBudget(selectedBudget);

            Message = "Expense deleted successfully.";
            IsErrorMessage = false;
        }
        else
        {
            IsErrorMessage = true;
            Message = "Failed to delete expense.";
        }

        _ = HideMessageAfterDelay();
        StateHasChanged();
    }



    //Models

    private void OpenUpdateModel(ProjectDto project)
    {
        selectedProject = project;
        showUpdateModal = true;
    }

    private void CloseUpdateModel()
    {
        showUpdateModal = false;
    }

    private void CloseBudgetModal()
    {
        showBudgetModal = false;
    }

    private void CloseTasksModal()
    {
        showTasksModal = false;
    }
    private void OpenUpdateTaskModal(ProjectTaskDto task)
    {
        selectedTaskForUpdate = task;
        showUpdateTaskModal = true;
    }

    private void CloseUpdateTaskModal()
    {
        showUpdateTaskModal = false;
    }

    private void OpenAddExpenseModal(BudgetDto selectedBudget)
    {
        newExpense = new ExpenseDto
        {
            DateIncurred = DateTime.Today
        };
        showAddExpenseModal = true;
        StateHasChanged(); // Odświeżenie stanu, aby zmiany zostały odzwierciedlone w UI
    }

    // Metoda do zamykania modala dodawania wydatku
    private void CloseAddExpenseModal()
    {
        showAddExpenseModal = false;
    }

    private void OpenUpdateExpenseModal(ExpenseDto expense)
    {
        originalExpenseForUpdate = new ExpenseDto
            {
                ExpenseId = expense.ExpenseId,
                Amount = expense.Amount,
                Category = expense.Category,
                DateIncurred = expense.DateIncurred
            };
        selectedExpenseForUpdate = expense; // To może być referencja do obiektu, który będzie edytowany w modalu
        showUpdateExpenseModal = true;

    }


    private void CloseUpdateExpenseModal()
    {
        showUpdateExpenseModal = false; // Zamknij modal
        originalExpenseForUpdate = null; // Resetuj oryginalny wydatek
        selectedExpenseForUpdate = null; // Resetuj wybrany wydatek do aktualizacji
        StateHasChanged(); // Odśwież stan komponentu
    }


    //HELPERS
    private async Task HideMessageAfterDelay()
    {
        await Task.Delay(2000); // Czekaj 2 sekundy
        Message = string.Empty;
        StateHasChanged(); // Odśwież komponent
    }

}
